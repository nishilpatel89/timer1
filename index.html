<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Do The Thing | Session Tracker</title>
    <meta name="description" content="A simple, no-nonsense chess clock for work. Track 'Doing the Thing' vs 'Not Doing the Thing'.">
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéØ</text></svg>">

    <script type="module" src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js"></script>

    <style>
        :root {
            /* Clean Light Theme */
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --text-primary: #2d3436;
            --text-secondary: #636e72;
            
            /* Action Colors */
            --work-color: #00b894; /* Mint Green */
            --break-color: #e17055; /* Terracotta Orange */
            --save-color: #0984e3; /* Blue */
            --ring-bg: #dfe6e9;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            height: 100vh;
            width: 100vw;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow-x: hidden;
        }

        .container {
            background: var(--card-bg);
            padding: clamp(1rem, 3vmin, 2.5rem); 
            border-radius: 24px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.05), 0 5px 15px rgba(0,0,0,0.03);
            text-align: center;
            width: 90%;
            max-width: 450px;
            max-height: 95vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            justify-content: center;
            border: 1px solid rgba(255,255,255,0.8);
            box-sizing: border-box;
            position: relative;
        }

        /* --- THE HUD (Ring) --- */
        .hud-wrapper {
            position: relative;
            width: clamp(150px, 35vmin, 220px);
            height: clamp(150px, 35vmin, 220px);
            margin: 0 auto clamp(1rem, 3vh, 2rem) auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .progress-ring { transform: rotate(-90deg); transform-origin: 50% 50%; width: 100%; height: 100%; }
        .progress-ring__circle { transition: stroke-dashoffset 0.35s; transform: rotate(-90deg); transform-origin: 50% 50%; }

        .hud-stats { position: absolute; display: flex; flex-direction: column; align-items: center; }
        .efficiency-big {
            font-size: clamp(2rem, 8vmin, 3.5rem);
            font-weight: 800;
            font-variant-numeric: tabular-nums;
            letter-spacing: -2px;
            color: var(--text-primary);
            line-height: 1;
        }
        .efficiency-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 2px; color: var(--text-secondary); margin-top: 2px; }

        /* --- TIMERS --- */
        .timers-row { display: flex; justify-content: space-between; margin-bottom: clamp(1rem, 3vh, 2rem); gap: 10px; }
        .timer-card {
            flex: 1; background: #f8f9fa; padding: clamp(0.5rem, 2vh, 1rem); border-radius: 16px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); border: 2px solid transparent; opacity: 0.5; transform: scale(0.98);
        }
        .timer-card.active { opacity: 1; transform: scale(1.02); background: #fff; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .timer-card.active.pulse-green { border-color: var(--work-color); animation: soft-pulse-green 3s infinite ease-in-out; }
        .timer-card.active.pulse-orange { border-color: var(--break-color); }

        @keyframes soft-pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(0, 184, 148, 0.2); }
            70% { box-shadow: 0 0 0 10px rgba(0, 184, 148, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 184, 148, 0); }
        }

        .timer-val { font-family: 'Courier New', monospace; font-size: clamp(1.2rem, 5vmin, 1.6rem); font-weight: 700; margin-top: 2px; color: var(--text-primary); }
        .timer-title { font-size: 0.65rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-secondary); font-weight: 600; white-space: nowrap; }

        /* --- SWITCH BUTTON --- */
        #switch-btn {
            background: #2d3436; color: white; width: 100%; padding: clamp(0.8rem, 2.5vh, 1.2rem); border-radius: 16px;
            font-size: clamp(0.9rem, 3vmin, 1.1rem); font-weight: 700; cursor: pointer; transition: all 0.2s; margin-bottom: 1rem; border: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-transform: uppercase; letter-spacing: 1px;
        }
        #switch-btn:active { transform: scale(0.98); }
        #switch-btn.mode-work { background: var(--work-color); box-shadow: 0 8px 20px rgba(0, 184, 148, 0.3); }
        #switch-btn.mode-break { background: var(--break-color); box-shadow: 0 8px 20px rgba(225, 112, 85, 0.3); }

        /* --- STREAK BADGE --- */
        .streak-container {
            margin-top: clamp(0.5rem, 2vh, 1.5rem); padding: 0.5rem 1rem; background: #f1f2f6; border-radius: 20px;
            display: inline-flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.8rem; color: var(--text-secondary); font-weight: 600;
        }
        .fire-icon { font-size: 1.1rem; filter: grayscale(100%); transition: 0.3s; }
        .streak-active .fire-icon { filter: grayscale(0%); transform: scale(1.1); }
        .streak-active { background: rgba(0, 184, 148, 0.1); color: #009476; }

        /* --- CONTROLS --- */
        .secondary-controls { display: flex; gap: 10px; width: 100%; margin-bottom: 10px; }
        .sec-btn { border: none; color: var(--text-secondary); padding: clamp(0.6rem, 2vh, 0.8rem); border-radius: 12px; cursor: pointer; font-size: 0.85rem; font-weight: 600; transition: 0.2s; flex: 1; }
        .btn-pause { background: #f1f2f6; } .btn-pause:hover { background: #e1e2e6; color: var(--text-primary); }
        .btn-save { background: rgba(9, 132, 227, 0.1); color: var(--save-color); } .btn-save:hover { background: rgba(9, 132, 227, 0.2); }
        .discard-link { font-size: 0.75rem; color: #b2bec3; text-decoration: none; cursor: pointer; padding: 5px; display: inline-block; margin-top: 5px; }
        .discard-link:hover { color: var(--break-color); text-decoration: underline; }

        /* --- OVERLAYS --- */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.98);
            display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; padding: 2rem; box-sizing: border-box; text-align: center;
        }
        .start-btn {
            background: var(--work-color); color: white; border: none; padding: 1rem 3rem;
            font-size: 1.5rem; font-weight: 700; border-radius: 50px; cursor: pointer;
            box-shadow: 0 10px 30px rgba(0, 184, 148, 0.3); transition: transform 0.2s;
        }
        .start-btn:hover { transform: scale(1.05); }
        .hidden { display: none !important; }

        /* Top Icons */
        .icon-btn { 
            position: absolute; top: 15px; background: #f1f2f6; border: none; color: var(--text-secondary);
            width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-weight: bold; z-index: 10;
            display: flex; align-items: center; justify-content: center; font-size: 1.1rem;
        }
        .icon-btn:hover { background: #e1e2e6; }
        .help-btn { right: 15px; }
        .history-btn { left: 15px; }
        .auth-btn { left: 55px; font-size: 0.9rem; } /* User Icon */
        
        .logged-in-badge { background: #00b894; color: white; }

        /* --- HISTORY LIST --- */
        .history-container { width: 100%; max-width: 400px; overflow-y: auto; max-height: 60vh; text-align: left; }
        .history-card {
            background: #f8f9fa; border-radius: 12px; padding: 10px 15px; margin-bottom: 10px;
            display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem;
        }
        .hist-date { font-weight: 600; color: var(--text-primary); display: block; font-size: 0.75rem; margin-bottom: 2px;}
        .hist-details { color: var(--text-secondary); }
        .hist-eff { font-weight: 800; }
        .eff-high { color: var(--work-color); }
        .eff-low { color: var(--break-color); }
        .delete-btn { background: none; border: none; color: #ccc; cursor: pointer; font-size: 1.2rem; padding: 0 0 0 10px; }
        .delete-btn:hover { color: var(--break-color); }
        
        /* Modal General */
        .modal-close-btn {
            background: var(--text-primary); color: white; border: none; padding: 0.8rem 2rem;
            border-radius: 12px; cursor: pointer; font-weight: 600; margin-top: 1rem; width: auto;
        }
        .auth-input { width: 100%; padding: 12px; margin: 5px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .auth-actions { display: flex; gap: 10px; width: 100%; max-width: 300px; margin-top: 10px; }

        /* SEO Text */
        .seo-text {
            max-width: 600px; margin: 2rem auto; color: var(--text-secondary); line-height: 1.6; text-align: left; padding: 0 1.5rem; font-size: 0.9rem;
        }
        @media (max-height: 700px) { .seo-text { display: none; } body { justify-content: center; padding-bottom: 0; } }

    </style>
</head>
<body>

    <div id="auth-screen" class="overlay hidden">
        <h2 id="auth-title" style="color:#2d3436; margin-bottom:1rem">User Login</h2>
        <div id="auth-form-container" style="width:100%; max-width:300px;">
            <p style="font-size:0.9rem; color:#666; margin-bottom:1rem;">Log in to save your history across devices.</p>
            <input type="email" id="auth-email" class="auth-input" placeholder="Email">
            <input type="password" id="auth-pass" class="auth-input" placeholder="Password">
            <p id="auth-error" style="color:#e17055; font-size:0.8rem; height:1rem;"></p>
            <div class="auth-actions">
                <button class="sec-btn btn-save" id="do-login">Log In</button>
                <button class="sec-btn" id="do-signup">Sign Up</button>
            </div>
        </div>
        
        <div id="user-info-container" class="hidden">
            <p>Logged in as: <strong id="user-email-display"></strong></p>
            <button class="sec-btn btn-pause" id="do-logout">Log Out</button>
        </div>

        <button class="modal-close-btn" id="close-auth">Close</button>
    </div>

    <div id="history-screen" class="overlay hidden">
        <h2 style="color:#2d3436; margin-bottom:1.5rem">Session History</h2>
        <div id="history-list" class="history-container"></div>
        <button class="modal-close-btn" id="close-history">Close</button>
    </div>

    <div id="help-screen" class="overlay hidden">
        <h2 style="color:#2d3436; margin-bottom:1rem">The Rules</h2>
        <ul style="color:#636e72; text-align:left; line-height:1.8; margin-bottom:1rem; padding-left: 20px;">
            <li>üéØ <strong>Doing the Thing:</strong> Deep Focus.</li>
            <li>üõë <strong>Not Doing:</strong> Phone, Email.</li>
            <li>üî• <strong>Streak:</strong> Maintain >75%.</li>
        </ul>
        <button class="modal-close-btn" id="close-help">Got it</button>
    </div>

    <div id="start-screen" class="overlay">
        <h1 style="color:#2d3436; font-size: clamp(2rem, 5vw, 2.5rem); margin-bottom:2rem; text-transform:uppercase; letter-spacing:1px; font-weight:800;">Do The Thing</h1>
        <button class="start-btn" id="start-btn">Start Session</button>
    </div>

    <div class="container">
        <button class="icon-btn history-btn" id="history-toggle" aria-label="History">üïí</button>
        <button class="icon-btn auth-btn" id="auth-toggle" aria-label="Account">üë§</button>
        <button class="icon-btn help-btn" id="help-toggle" aria-label="Help">?</button>

        <div class="hud-wrapper">
            <svg class="progress-ring" viewBox="0 0 220 220">
                <circle class="progress-ring__bg" stroke="#dfe6e9" stroke-width="12" fill="transparent" r="90" cx="110" cy="110"/>
                <circle class="progress-ring__circle" id="progress-circle" stroke="#00b894" stroke-width="12" stroke-linecap="round" fill="transparent" r="90" cx="110" cy="110"/>
            </svg>
            <div class="hud-stats">
                <span class="efficiency-big" id="eff-display">100%</span>
                <span class="efficiency-label">Efficiency</span>
            </div>
        </div>

        <div class="timers-row">
            <div id="work-card" class="timer-card active pulse-green">
                <div class="timer-title">Doing the Thing</div>
                <div class="timer-val" id="work-time">00:00:00</div>
            </div>
            <div id="break-card" class="timer-card">
                <div class="timer-title">Not Doing</div>
                <div class="timer-val" id="break-time">00:00:00</div>
            </div>
        </div>

        <div id="streak-badge" class="streak-container">
            <span class="fire-icon">üî•</span>
            <span id="streak-text">Focus Zone Active</span>
        </div>

        <div style="margin-top: clamp(1rem, 3vh, 2rem);">
            <button id="switch-btn" class="mode-work">Switch to Not Doing</button>
            <div class="secondary-controls">
                <button class="sec-btn btn-pause" id="pause-btn">Pause</button>
                <button class="sec-btn btn-save" id="save-btn">Finish & Save</button>
            </div>
            <div class="discard-link" id="discard-btn">Discard Session (Reset)</div>
        </div>
    </div>

    <div class="seo-text">
        <h2>The Honest Productivity Timer for Deep Work</h2>
        <p>Most productivity timers are too complicated. <strong>Do The Thing</strong> acts like a chess clock for your workday. It forces you to be honest about how you spend your time.  Whether you are managing ADHD, trying to improve your focus, or just want to audit your daily efficiency, this tool gives you immediate feedback. Simply click the switch when you stop "Doing the Thing" (working) and click it back when you return to focus.</p>
    </div>

    <script type="module">
        // --- FIREBASE IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, orderBy, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // ==========================================
        // üö® YOUR FIREBASE CONFIGURATION üö®
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyA2ysrcWSmiiUIrIRHl8JGdYeSfrPLqpUg",
            authDomain: "dothething-babad.firebaseapp.com",
            projectId: "dothething-babad",
            storageBucket: "dothething-babad.firebasestorage.app",
            messagingSenderId: "543977536594",
            appId: "1:543977536594:web:9d2bd28103c31d2393f38b",
            measurementId: "G-7H5301SWBC"
        };

        // --- INIT FIREBASE (Safe Fail) ---
        let auth, db, user = null;
        let isCloudActive = false;
        
        if (firebaseConfig.apiKey) {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                isCloudActive = true;
            } catch (e) { console.error("Firebase Init Error:", e); }
        }

        // --- APP STATE ---
        const GOAL = 75;
        let workSec = 0, breakSec = 0;
        let isWorking = true, isPaused = false, hasStarted = false;
        let interval = null;
        let sessionHistory = [];

        // --- DOM ---
        const el = {
            workTime: document.getElementById('work-time'),
            breakTime: document.getElementById('break-time'),
            effDisplay: document.getElementById('eff-display'),
            circle: document.getElementById('progress-circle'),
            switchBtn: document.getElementById('switch-btn'),
            workCard: document.getElementById('work-card'),
            breakCard: document.getElementById('break-card'),
            streakBadge: document.getElementById('streak-badge'),
            pauseBtn: document.getElementById('pause-btn'),
            historyList: document.getElementById('history-list'),
            authBtn: document.getElementById('auth-toggle'),
            authError: document.getElementById('auth-error'),
            userDisplay: document.getElementById('user-email-display')
        };

        // --- CIRCLE UI ---
        const circumference = 90 * 2 * Math.PI;
        el.circle.style.strokeDasharray = `${circumference} ${circumference}`;
        el.circle.style.strokeDashoffset = 0;

        function setProgress(percent) {
            const offset = circumference - (percent / 100) * circumference;
            el.circle.style.strokeDashoffset = offset;
            if(percent >= GOAL) {
                el.circle.style.stroke = "var(--work-color)";
                el.effDisplay.style.color = "var(--text-primary)";
                el.streakBadge.classList.add('streak-active');
                el.streakBadge.innerHTML = '<span class="fire-icon">üî•</span> High Efficiency Zone';
            } else {
                el.circle.style.stroke = "var(--break-color)";
                el.effDisplay.style.color = "var(--break-color)";
                el.streakBadge.classList.remove('streak-active');
                el.streakBadge.innerHTML = '<span class="fire-icon">‚ö†Ô∏è</span> Focus Required';
            }
        }

        // --- DATA LAYER (HYBRID) ---
        
        async function loadHistory() {
            // 1. Always load local first for instant UI
            const localHist = localStorage.getItem('dtt_history');
            if(localHist) sessionHistory = JSON.parse(localHist);

            // 2. If Logged In, fetch cloud and merge/overwrite
            if(user && db) {
                const q = query(collection(db, "users", user.uid, "sessions"), orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);
                sessionHistory = []; // Replace local with cloud truth
                querySnapshot.forEach((doc) => {
                    sessionHistory.push({ ...doc.data(), id: doc.id });
                });
                renderHistory();
            }
        }

        async function saveSessionToStorage(entry) {
            // Add to Memory
            sessionHistory.unshift(entry);
            
            // Save to Local
            localStorage.setItem('dtt_history', JSON.stringify(sessionHistory));

            // Save to Cloud (if logged in)
            if(user && db) {
                try {
                    // Use timestamp as ID for sorting
                    await setDoc(doc(db, "users", user.uid, "sessions", entry.id.toString()), {
                        ...entry,
                        createdAt: new Date()
                    });
                } catch(e) { console.error("Cloud Save Fail", e); }
            }
        }

        async function deleteSessionFromStorage(id) {
            // Update Memory & Local
            sessionHistory = sessionHistory.filter(item => item.id !== id);
            localStorage.setItem('dtt_history', JSON.stringify(sessionHistory));
            renderHistory();

            // Update Cloud
            if(user && db) {
                try {
                    await deleteDoc(doc(db, "users", user.uid, "sessions", id.toString()));
                } catch(e) { console.error("Cloud Delete Fail", e); }
            }
        }

        // --- AUTH LOGIC ---
        if(isCloudActive) {
            onAuthStateChanged(auth, (currentUser) => {
                user = currentUser;
                if(user) {
                    el.authBtn.classList.add('logged-in-badge');
                    document.getElementById('auth-form-container').classList.add('hidden');
                    document.getElementById('user-info-container').classList.remove('hidden');
                    el.userDisplay.innerText = user.email;
                    loadHistory(); // Fetch cloud data
                } else {
                    el.authBtn.classList.remove('logged-in-badge');
                    document.getElementById('auth-form-container').classList.remove('hidden');
                    document.getElementById('user-info-container').classList.add('hidden');
                    // Revert to local storage only
                    const localHist = localStorage.getItem('dtt_history');
                    sessionHistory = localHist ? JSON.parse(localHist) : [];
                }
            });

            document.getElementById('do-login').addEventListener('click', async () => {
                const email = document.getElementById('auth-email').value;
                const pass = document.getElementById('auth-pass').value;
                try {
                    await signInWithEmailAndPassword(auth, email, pass);
                    document.getElementById('auth-screen').classList.add('hidden');
                } catch(e) { el.authError.innerText = "Login failed: " + e.code; }
            });

            document.getElementById('do-signup').addEventListener('click', async () => {
                const email = document.getElementById('auth-email').value;
                const pass = document.getElementById('auth-pass').value;
                try {
                    await createUserWithEmailAndPassword(auth, email, pass);
                    document.getElementById('auth-screen').classList.add('hidden');
                } catch(e) { el.authError.innerText = "Signup failed: " + e.code; }
            });

            document.getElementById('do-logout').addEventListener('click', () => {
                signOut(auth);
            });
        } else {
            // No Keys Provided
            document.getElementById('auth-toggle').addEventListener('click', () => {
                alert("Cloud Sync is not configured. Please add Firebase keys to the code to enable login.");
            });
        }


        // --- UI & TIMER LOGIC ---
        function format(s) { return new Date(s * 1000).toISOString().substr(11, 8); }
        function updateUI() {
            el.workTime.innerText = format(workSec);
            el.breakTime.innerText = format(breakSec);
            const total = workSec + breakSec;
            const eff = total === 0 ? 100 : Math.round((workSec / total) * 100);
            el.effDisplay.innerText = eff + "%";
            setProgress(eff);
        }

        function tick() {
            if(!isPaused && hasStarted) {
                if(isWorking) workSec++; else breakSec++;
                updateUI();
                localStorage.setItem('dtt_current_work', workSec);
                localStorage.setItem('dtt_current_break', breakSec);
            }
        }

        function toggleTimer() {
            isWorking = !isWorking;
            if(isWorking) {
                el.switchBtn.innerText = "Switch to Not Doing";
                el.switchBtn.className = "mode-work"; 
                el.workCard.classList.add('active', 'pulse-green');
                el.breakCard.classList.remove('active', 'pulse-orange');
            } else {
                el.switchBtn.innerText = "Switch to Doing the Thing";
                el.switchBtn.className = "mode-break"; 
                el.breakCard.classList.add('active', 'pulse-orange');
                el.workCard.classList.remove('active', 'pulse-green');
            }
        }

        // --- BUTTON EVENTS ---
        document.getElementById('start-btn').addEventListener('click', () => {
            hasStarted = true;
            document.getElementById('start-screen').classList.add('hidden');
            // Load current running session if exists
            const savedWork = localStorage.getItem('dtt_current_work');
            if(savedWork) { workSec = parseInt(savedWork); breakSec = parseInt(localStorage.getItem('dtt_current_break')); }
            updateUI();
            interval = setInterval(tick, 1000);
            toggleTimer(); isWorking = !isWorking; toggleTimer();
        });

        el.switchBtn.addEventListener('click', () => {
            if(!hasStarted) return;
            if(isPaused) { isPaused = false; el.pauseBtn.innerText = "Pause"; interval = setInterval(tick, 1000); }
            toggleTimer();
        });

        el.pauseBtn.addEventListener('click', () => {
            if(!hasStarted) return;
            isPaused = !isPaused;
            if(isPaused) {
                clearInterval(interval);
                el.pauseBtn.innerText = "Resume";
                el.workCard.classList.remove('pulse-green');
                el.breakCard.classList.remove('pulse-orange');
            } else {
                interval = setInterval(tick, 1000);
                el.pauseBtn.innerText = "Pause";
                if(isWorking) el.workCard.classList.add('pulse-green'); else el.breakCard.classList.add('pulse-orange');
            }
        });

        document.getElementById('save-btn').addEventListener('click', () => {
            if(!hasStarted || (workSec===0 && breakSec===0)) return;
            if(confirm("Finish & Save?")) {
                const total = workSec + breakSec;
                const eff = Math.round((workSec / total) * 100);
                const entry = {
                    id: Date.now(),
                    date: new Date().toLocaleDateString(undefined, { month: 'short', day: 'numeric', hour: '2-digit', minute:'2-digit' }),
                    work: workSec,
                    break: breakSec,
                    eff: eff
                };
                saveSessionToStorage(entry);
                resetApp();
            }
        });

        document.getElementById('discard-btn').addEventListener('click', () => {
            if(confirm("Discard without saving?")) resetApp();
        });

        function resetApp() {
            localStorage.removeItem('dtt_current_work');
            localStorage.removeItem('dtt_current_break');
            workSec = 0; breakSec = 0;
            clearInterval(interval);
            updateUI();
            document.getElementById('start-screen').classList.remove('hidden');
            hasStarted = false; isPaused = false; el.pauseBtn.innerText = "Pause";
        }

        // --- OVERLAY HANDLERS ---
        window.deleteSession = deleteSessionFromStorage; // Expose for inline click

        function renderHistory() {
            if(sessionHistory.length === 0) { el.historyList.innerHTML = '<div class="empty-state" style="color:#aaa; font-style:italic;">No saved sessions.</div>'; return; }
            el.historyList.innerHTML = sessionHistory.map(item => `
                <div class="history-card">
                    <div>
                        <span class="hist-date">${item.date}</span>
                        <span class="hist-details">Doing: ${Math.floor(item.work / 60)}m | Not Doing: ${Math.floor(item.break / 60)}m</span>
                    </div>
                    <div style="display:flex; align-items:center;">
                        <span class="hist-eff ${item.eff >= GOAL ? 'eff-high' : 'eff-low'}">${item.eff}%</span>
                        <button class="delete-btn" onclick="deleteSession(${item.id})">&times;</button>
                    </div>
                </div>
            `).join('');
        }

        document.getElementById('history-toggle').addEventListener('click', () => { renderHistory(); document.getElementById('history-screen').classList.remove('hidden'); });
        document.getElementById('close-history').addEventListener('click', () => document.getElementById('history-screen').classList.add('hidden'));
        document.getElementById('auth-toggle').addEventListener('click', () => { if(isCloudActive) document.getElementById('auth-screen').classList.remove('hidden'); });
        document.getElementById('close-auth').addEventListener('click', () => document.getElementById('auth-screen').classList.add('hidden'));
        document.getElementById('help-toggle').addEventListener('click', () => document.getElementById('help-screen').classList.remove('hidden'));
        document.getElementById('close-help').addEventListener('click', () => document.getElementById('help-screen').classList.add('hidden'));

        // Load Initial
        loadHistory();
    </script>
</body>
</html>


